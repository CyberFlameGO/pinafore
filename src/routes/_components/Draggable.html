<div class="draggable-area {draggableClass} "
     style={touchStyle}
     on:pointerMove="onPointerMove(event)"
     on:pointerLeave="onPointerLeave(event)"
     on:click="onClick(event)"
     ref:area
>
  <div class="draggable-indicator {indicatorClass}"
       style={indicatorStyle}
       on:pointerDown="onPointerDown(event)"
       on:pointerUp="onPointerUp(event)"
       ref:indicator
  >
    <div class="draggable-indicator-inner">
      <slot></slot>
    </div>
  </div>
</div>
<style>
  .draggable-area {
    position: relative;
  }
  .draggable-indicator {
    position: absolute;
    cursor: pointer;
  }
  .draggable-indicator-inner {
    pointer-events: none;
    display: flex;
  }
</style>
<script>
  import { throttleRaf } from '../_utils/throttleRaf'
  import {
    hasPointerEvents,
    pointerUp,
    pointerDown,
    pointerLeave,
    pointerMove
  } from '../_utils/pointerEvents'

  const clamp = x => Math.max(0, Math.min(1, x))
  const throttledRaf = throttleRaf()

  export default {
    data: () => ({
      draggableClass: '',
      indicatorClass: '',
      x: 0,
      y: 0,
      indicatorWidth: 0,
      indicatorHeight: 0,
      hasPointerEvents
    }),
    computed: {
      indicatorStyle: ({ x, y, indicatorWidth, indicatorHeight }) => (
        `left: calc(${x * 100}% - ${indicatorWidth / 2}px); top: calc(${y * 100}% - ${indicatorHeight / 2}px);`
      ),
      touchStyle: ({ hasPointerEvents }) => hasPointerEvents ? 'touch-action:none' : ''
    },
    methods: {
      onPointerDown (e) {
        console.log('onPointerDown')
        e.preventDefault()
        e.stopPropagation()
        const rect = this.refs.indicator.getBoundingClientRect()
        this.set({
          dragging: true,
          dragOffsetX: e.clientX - rect.left,
          dragOffsetY: e.clientY - rect.top
        })
      },
      onPointerMove (e) {
        console.log('Draggable: onPointerMove')
        if (this.get().dragging) {
          console.log('Draggable: dragging')
          e.preventDefault()
          e.stopPropagation()
          const { indicatorWidth, indicatorHeight, dragOffsetX, dragOffsetY } = this.get()
          throttledRaf(() => {
            console.log('Draggable: throttledRaf')
            const rect = this.refs.area.getBoundingClientRect()
            const offsetX = dragOffsetX - (indicatorWidth / 2)
            const offsetY = dragOffsetY - (indicatorHeight / 2)
            const x = clamp((e.clientX - rect.left - offsetX) / rect.width)
            const y = clamp((e.clientY - rect.top - offsetY) / rect.height)
            this.set({ x, y })
            this.fire('change', { x, y })
          })
        }
      },
      onPointerUp (e) {
        console.log('Draggable: onPointerUp')
        e.preventDefault()
        e.stopPropagation()
        this.set({ dragging: false })
      },
      onPointerLeave (e) {
        console.log('Draggable: onPointerLeave')
        e.preventDefault()
        e.stopPropagation()
        this.set({ dragging: false })
      },
      onClick (e) {
        console.log('Draggable: onClick')
        if (!e.target.classList.contains('draggable-indicator')) {
          console.log('Draggable: clickHandled')
          e.preventDefault()
          e.stopPropagation()
          const rect = this.refs.area.getBoundingClientRect()
          const x = clamp((e.clientX - rect.left) / rect.width)
          const y = clamp((e.clientY - rect.top) / rect.height)
          this.set({ x, y })
          this.fire('change', { x, y })
        }
      }
    },
    events: {
      pointerUp,
      pointerDown,
      pointerLeave,
      pointerMove
    }
  }
</script>
